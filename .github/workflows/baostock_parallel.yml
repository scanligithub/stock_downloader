# .github/workflows/baostock_parallel.yml (Baostock-powered list generation)

name: ğŸ‚ Baostock å…¨Aè‚¡å†å²æ•°æ®åˆ†å¸ƒå¼ä¸‹è½½ï¼ˆå« Baostock åˆ—è¡¨é˜¶æ®µï¼‰

on:
  workflow_dispatch:

jobs:
  # ======================== 1ï¸âƒ£ è·å–è‚¡ç¥¨åˆ—è¡¨ (å·²ä¿®æ”¹ä¸º Baostock) ========================
  get_stock_list:
    name: è·å–è‚¡ç¥¨åˆ—è¡¨ (Baostock)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Baostock dependencies
        # (å…³é”®ä¿®æ”¹ 1) ä¾èµ–ä» tushare æ”¹ä¸º baostock
        run: pip install baostock pandas

      - name: ğŸ§© Run Baostock script to generate list
        # (å…³é”®ä¿®æ”¹ 2) è¿™é‡Œæ˜¯ç»è¿‡éªŒè¯çš„ã€èƒ½æˆåŠŸè·å–åˆ—è¡¨çš„ Baostock è„šæœ¬
        run: |
          python - <<'PY'
          import baostock as bs
          import pandas as pd
          import json
          from datetime import datetime, timedelta

          print("ğŸš€ å¼€å§‹ä» Baostock è·å–å…¨Aè‚¡åˆ—è¡¨...")
          
          lg = bs.login()
          if lg.error_code != '0':
              raise Exception(f"ç™»å½•å¤±è´¥: {lg.error_msg}")
          print("âœ… ç™»å½•æˆåŠŸï¼")

          def get_recent_trade_day():
              """æ™ºèƒ½è·å–æœ€è¿‘çš„äº¤æ˜“æ—¥"""
              for i in range(1, 7): # æœ€å¤šå›æº¯ä¸€å‘¨
                  day = (datetime.now() - timedelta(days=i)).strftime('%Y-%m-%d')
                  rs = bs.query_trade_dates(start_date=day, end_date=day)
                  if rs.error_code == '0' and rs.next() and rs.get_row_data()[1] == '1':
                      print(f"ğŸ“… è‡ªåŠ¨è·å–åˆ°æœ€è¿‘äº¤æ˜“æ—¥: {day}")
                      return day
              raise Exception("ä¸€å‘¨å†…æœªæ‰¾åˆ°æœ‰æ•ˆäº¤æ˜“æ—¥ï¼Œè¯·æ£€æŸ¥ Baostock æœåŠ¡çŠ¶æ€ã€‚")

          try:
              trade_day = get_recent_trade_day()
              rs_stock = bs.query_all_stock(day=trade_day)
              
              if rs_stock.error_code != '0':
                  raise Exception(f"è·å–è‚¡ç¥¨åˆ—è¡¨å¤±è´¥: {rs_stock.error_msg}")
              
              stock_df = rs_stock.get_data()

              if stock_df.empty:
                  raise Exception("è·å–åˆ°çš„è‚¡ç¥¨åˆ—è¡¨ä¸ºç©ºï¼Œè¯·æ£€æŸ¥ Baostock æœåŠ¡çŠ¶æ€ã€‚")

              stock_list = []
              for index, row in stock_df.iterrows():
                  code = row['code']
                  name = row['code_name']
                  if str(code).startswith(('sh.', 'sz.', 'bj.')):
                      if 'ST' not in name and 'é€€' not in name:
                          stock_list.append({'code': code, 'name': name})
                      
              print(f"ğŸ“ˆ å…±è·å–å¹¶ç­›é€‰å‡º {len(stock_list)} æ”¯æœ‰æ•ˆAè‚¡è‚¡ç¥¨")

              with open("stock_list.json", "w", encoding="utf-8") as f:
                  json.dump(stock_list, f, ensure_ascii=False, indent=2)

              print("âœ… stock_list.json æ–‡ä»¶å·²æˆåŠŸç”Ÿæˆã€‚")

          finally:
              bs.logout()
              print("âœ… å·²ç™»å‡ºã€‚")
          PY

      - name: ğŸ“¤ Upload stock list artifact
        uses: actions/upload-artifact@v4
        with:
          name: stock_list # äº§ç‰©åç§°ä¿æŒä¸å˜ï¼Œä¸‹æ¸¸ä½œä¸šå¯æ— ç¼è¡”æ¥
          path: stock_list.json

  # ======================== 2ï¸âƒ£ å¹¶è¡Œä¸‹è½½éƒ¨åˆ† (æ— éœ€ä¿®æ”¹) ========================
  download:
    name: ä¸‹è½½åˆ†åŒº ${{ matrix.task_index }}
    needs: get_stock_list
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task_index: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
      max-parallel: 20

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download stock list artifact
        uses: actions/download-artifact@v4
        with:
          name: stock_list
          path: .

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: pip install baostock pandas pyarrow tqdm

      - name: ğŸ“ˆ Run Baostock parallel downloader
        env:
          TASK_INDEX: ${{ matrix.task_index }}
          TASK_COUNT: 20
        run: |
          # (è¯´æ˜) è¿™æ®µ fallback é€»è¾‘ç°åœ¨å˜å¾—å¤šä½™ï¼Œä½†ä¿ç•™ä¹Ÿæ— å¦¨
          if [ ! -s stock_list.json ]; then
            echo "âš ï¸ æœªæ£€æµ‹åˆ° stock_list.jsonï¼Œä½¿ç”¨ä»“åº“æ ¹ç›®å½•æ–‡ä»¶..."
            cp ./stock_list.json ./stock_list.json
          fi
          mkdir -p data
          python scripts/download_baostock_parallel.py

      - name: ğŸ“¤ Upload partition artifact
        uses: actions/upload-artifact@v4
        with:
          name: data_part_${{ matrix.task_index }}
          path: data/

  # ======================== 3ï¸âƒ£ åˆå¹¶æ‰€æœ‰ç»“æœ (æ— éœ€ä¿®æ”¹) ========================
  merge:
    name: åˆå¹¶æ‰€æœ‰ç»“æœ
    needs: download
    runs-on: ubuntu-latest
    # ... merge ä½œä¸šçš„ steps å®Œå…¨ä¿æŒä¸å˜ ...
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all_data

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: pip install pandas pyarrow tqdm

      - name: ğŸ”„ Merge all results
        run: |
          mkdir -p data
          find all_data -type f -name "*.csv" -exec cp {} data/ \;
          python scripts/merge_results.py

      - name: ğŸ“¦ Compress merged data
        run: zip -r all_data.zip data

      - name: ğŸ“¤ Upload merged dataset
        uses: actions/upload-artifact@v4
        with:
          name: all_data_zip
          path: all_data.zip
